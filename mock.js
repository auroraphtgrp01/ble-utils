const data = {
    code: 0,
    dataType: 1284,
    data: [{
        startTime: "01:21 26/04/2025",
        endTime: "02:30 26/04/2025",
        deepSleepCount: 65535,
        lightSleepCount: 0,
        deepSleepTotal: 452,
        lightSleepTotal: 3389,
        rapidEyeMovementTotal: 318,
        sleepData: [{
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "01:21 26/04/2025",
            sleepLen: 1356
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "01:43 26/04/2025",
            sleepLen: 336
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "01:49 26/04/2025",
            sleepLen: 251
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "01:53 26/04/2025",
            sleepLen: 838
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "02:07 26/04/2025",
            sleepLen: 67
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "02:08 26/04/2025",
            sleepLen: 1172
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "02:28 26/04/2025",
            sleepLen: 116
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "02:30 26/04/2025",
            sleepLen: 23
        }
        ],
        wakeCount: 0,
        wakeDuration: 0
    },
    {
        startTime: "02:31 26/04/2025",
        endTime: "08:37 26/04/2025",
        deepSleepCount: 65535,
        lightSleepCount: 0,
        deepSleepTotal: 3485,
        lightSleepTotal: 14884,
        rapidEyeMovementTotal: 3599,
        sleepData: [{
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "02:31 26/04/2025",
            sleepLen: 1290
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "02:52 26/04/2025",
            sleepLen: 447
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "03:00 26/04/2025",
            sleepLen: 223
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "03:03 26/04/2025",
            sleepLen: 691
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "03:15 26/04/2025",
            sleepLen: 260
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "03:19 26/04/2025",
            sleepLen: 1317
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "03:41 26/04/2025",
            sleepLen: 100
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "03:43 26/04/2025",
            sleepLen: 285
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "03:47 26/04/2025",
            sleepLen: 1659
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "04:15 26/04/2025",
            sleepLen: 99
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "04:17 26/04/2025",
            sleepLen: 212
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "04:20 26/04/2025",
            sleepLen: 91
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "04:22 26/04/2025",
            sleepLen: 1253
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "04:43 26/04/2025",
            sleepLen: 370
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "04:49 26/04/2025",
            sleepLen: 440
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "04:56 26/04/2025",
            sleepLen: 139
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "04:59 26/04/2025",
            sleepLen: 61
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "05:00 26/04/2025",
            sleepLen: 1154
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "05:19 26/04/2025",
            sleepLen: 327
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "05:24 26/04/2025",
            sleepLen: 222
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "05:28 26/04/2025",
            sleepLen: 758
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "05:41 26/04/2025",
            sleepLen: 222
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "05:44 26/04/2025",
            sleepLen: 1359
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "06:07 26/04/2025",
            sleepLen: 448
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "06:15 26/04/2025",
            sleepLen: 460
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "06:22 26/04/2025",
            sleepLen: 480
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "06:30 26/04/2025",
            sleepLen: 87
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "06:32 26/04/2025",
            sleepLen: 687
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "06:43 26/04/2025",
            sleepLen: 534
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "06:52 26/04/2025",
            sleepLen: 117
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "06:54 26/04/2025",
            sleepLen: 197
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "06:57 26/04/2025",
            sleepLen: 4
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "06:57 26/04/2025",
            sleepLen: 96
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "06:59 26/04/2025",
            sleepLen: 1350
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "07:21 26/04/2025",
            sleepLen: 204
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "07:25 26/04/2025",
            sleepLen: 360
        },
        {
            sleepType: 241,
            type: "deepSleep",
            sleepStartTime: "07:31 26/04/2025",
            sleepLen: 1490
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "07:56 26/04/2025",
            sleepLen: 1534
        },
        {
            sleepType: 243,
            type: "rem",
            sleepStartTime: "08:21 26/04/2025",
            sleepLen: 61
        },
        {
            sleepType: 242,
            type: "lightSleep",
            sleepStartTime: "08:22 26/04/2025",
            sleepLen: 880
        }
        ],
        wakeCount: 0,
        wakeDuration: 0
    }
    ]
}

function groupSleepData(sleepData) {
    const result = [];
    const typeMap = {};

    for (const item of sleepData) {
        if (!typeMap[item.sleepType]) {
            typeMap[item.sleepType] = {
                sleepType: item.type,
                totalMinutes: 0,
                stageTime: []
            };
            result.push(typeMap[item.sleepType]);
        }

        typeMap[item.sleepType].stageTime.push({
            startTime: item.sleepStartTime,
            sleepLen: item.sleepLen
        });
        // Cộng dồn thời gian ngủ (đơn vị phút)
        typeMap[item.sleepType].totalMinutes += item.sleepLen / 60;
    }

    return result;
}

function getFinalSleepData(sleepData) {
    const newData = sleepData.data.map((item) => {
        const { deepSleepCount, lightSleepCount, deepSleepTotal, lightSleepTotal, rapidEyeMovementTotal, wakeCount, wakeDuration, ...rest } = item;
        return {
            ...rest,
            sleepData: groupSleepData(item.sleepData)
        };
    });

    const overview = {
        wakeupCount: data.data.length,
        startDate: data.data[0]?.startTime,
        endDate: data.data[data.data.length - 1]?.endTime,
        totalDeepSleep: Number(newData.reduce((total, item) => {
            const deepSleep = item.sleepData.find(stage => stage.sleepType === "deepSleep");
            return total + (deepSleep?.totalMinutes || 0);
        }, 0).toFixed(2)),
        totalLightSleep: Number(newData.reduce((total, item) => {
            const lightSleep = item.sleepData.find(stage => stage.sleepType === "lightSleep");
            return total + (lightSleep?.totalMinutes || 0);
        }, 0).toFixed(2)),
        totalREM: Number(newData.reduce((total, item) => {
            const rem = item.sleepData.find(stage => stage.sleepType === "rem");
            return total + (rem?.totalMinutes || 0);
        }, 0).toFixed(2)),
        totalSleepTime: Number(newData.reduce((total, item) => {
            return total + item.sleepData.reduce((sum, stage) => sum + stage.totalMinutes, 0);
        }, 0).toFixed(2))
    };

    return {
        overview,
        sleepData: newData
    }
}



console.log(JSON.stringify(getFinalSleepData(data), null, 2));

